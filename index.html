<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DayZ CCG - Spectator View</title>
  <link rel="stylesheet" href="styles/spectator.css">
  <!-- ðŸ§© quiet the 404 for /favicon.ico -->
  <link rel="icon" href="images/cards/000.png">
  <style>
    /* ðŸ”Š Tiny audio toggle */
    .audio-toggle {
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 9999;
      background: rgba(0,0,0,0.65);
      color: #fff;
      border: 1px solid #00ffff;
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 12px;
      cursor: pointer;
      user-select: none;
      backdrop-filter: blur(2px);
    }
    .audio-toggle:hover { box-shadow: 0 0 10px #00ffff; }

    /* simple inline styles for the piles row (uses classes, not IDs) */
    .piles {
      margin: 6px 0 10px;
      color: #cfe9ff;
      font-size: 13px;
      opacity: 0.9;
    }
    .piles strong { font-weight: 700; }
  </style>

  <!-- ðŸŒ Token/API boot; expose to scripts and persist token -->
  <script>
    (function () {
      const qs = new URLSearchParams(location.search);
      const tokenFromUrl = qs.get('token') || '';
      const apiFromUrl = (qs.get('api') || '').replace(/\/+$/, '');

      // Persist/reuse token across UIs
      let token = tokenFromUrl;
      try {
        if (!token) token = localStorage.getItem('sv13.token') || '';
        if (tokenFromUrl) localStorage.setItem('sv13.token', tokenFromUrl);
      } catch {}

      // Globals for any scripts (e.g., spectatorview.js)
      window.PLAYER_TOKEN = token;
      window.API_BASE = apiFromUrl || '/api';
      try { console.log('[Spectator] API_BASE =', window.API_BASE); } catch {}
    })();
  </script>
</head>
<body>
  <div id="background"></div>

  <div class="spectator-header">
    <h1>Spectator View</h1>
    <p id="spectator-status">Waiting for match...</p>
    <p id="watching-count">Spectators Watching: 0</p>
  </div>

  <p id="turn-display" style="text-align:center; color:white; font-size: 18px;"></p>

  <div class="duel-container">
    <div class="player" id="player2">
      <h2 id="player2-name">Opponent</h2>
      <div class="hp">HP: <span id="player2-hp">200</span></div>
      <!-- ðŸ§® deck/discard counts (Spectator JS fills .deck-count / .discard-count) -->
      <div class="piles">
        Deck: <strong class="deck-count">0</strong> â€¢
        Discard: <strong class="discard-count">0</strong>
      </div>
      <div class="field" id="player2-field"></div>
      <div class="hand" id="player2-hand"></div>
    </div>

    <div class="player" id="player1">
      <h2 id="player1-name">Challenger</h2>
      <div class="hp">HP: <span id="player1-hp">200</span></div>
      <!-- ðŸ§® deck/discard counts -->
      <div class="piles">
        Deck: <strong class="deck-count">0</strong> â€¢
        Discard: <strong class="discard-count">0</strong>
      </div>
      <div class="field" id="player1-field"></div>
      <div class="hand" id="player1-hand"></div>
    </div>
  </div>

  <!-- ðŸ”Š Background music -->
  <audio
    id="spec-bgm"
    src="audio/bg/Follow the Trail.mp3"
    autoplay
    muted
    playsinline
    loop
    preload="auto"></audio>
  <button id="specAudioToggle" class="audio-toggle" aria-label="Mute background music">ðŸ”‡</button>

  <script>
    // Autoplay-safe music control (unmutes on first tap/keypress)
    (function setupSpectatorMusic() {
      const audio = document.getElementById('spec-bgm');
      const btn   = document.getElementById('specAudioToggle');
      if (!audio || !btn) return;

      const STORE_KEY = 'sv13_spectator_bgm.muted';

      // Restore saved preference
      try {
        const stored = localStorage.getItem(STORE_KEY);
        if (stored !== null) audio.muted = (stored === 'true');
      } catch {}

      updateBtn();
      audio.play().catch(() => { /* will unlock on first gesture */ });

      // First user gesture: ensure playback; unmute unless user previously chose mute
      const unlock = () => {
        audio.play().catch(() => {});
        try {
          if (localStorage.getItem(STORE_KEY) !== 'true') {
            audio.muted = false;
            updateBtn();
          }
        } catch {}
        cleanupUnlock();
      };
      function cleanupUnlock() {
        window.removeEventListener('pointerdown', unlock, opt);
        window.removeEventListener('keydown', unlock);
        document.removeEventListener('visibilitychange', vis);
      }
      const opt = { passive: true };
      window.addEventListener('pointerdown', unlock, opt);
      window.addEventListener('keydown', unlock);

      // Safari quirk: retry when tab becomes visible
      const vis = () => { if (!document.hidden) audio.play().catch(() => {}); };
      document.addEventListener('visibilitychange', vis);

      // Manual toggle
      btn.addEventListener('click', () => {
        audio.muted = !audio.muted;
        try { localStorage.setItem(STORE_KEY, String(audio.muted)); } catch {}
        updateBtn();
        audio.play().catch(() => {});
      });

      function updateBtn() {
        btn.textContent = audio.muted ? 'ðŸ”‡' : 'ðŸ”Š';
        btn.setAttribute('aria-label', audio.muted ? 'Play background music' : 'Mute background music');
      }
    })();
  </script>

  <!-- Load the spectator script (IIFE) -->
  <script src="scripts/spectatorview.js"></script>
</body>
</html>
