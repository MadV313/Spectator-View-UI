<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DayZ CCG - Spectator View</title>
  <link rel="stylesheet" href="styles/spectator.css">

  <!-- ✅ Silence icon-related 404s by using local assets that exist -->
  <link rel="icon" href="images/cards/000_CardBack_Unique.png">
  <link rel="icon" type="image/png" sizes="32x32" href="images/cards/000_CardBack_Unique.png">
  <link rel="icon" type="image/png" sizes="192x192" href="images/cards/000_CardBack_Unique.png">
  <link rel="apple-touch-icon" href="images/cards/000_CardBack_Unique.png">

  <style>
    /* 🔊 Tiny audio toggle */
    .audio-toggle {
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 9999;
      background: rgba(0,0,0,0.65);
      color: #fff;
      border: 1px solid #00ffff;
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 12px;
      cursor: pointer;
      user-select: none;
      backdrop-filter: blur(2px);
    }
    .audio-toggle:hover { box-shadow: 0 0 10px #00ffff; }

    /* simple inline styles for the piles row (uses classes, not IDs) */
    .piles {
      margin: 6px 0 10px;
      color: #cfe9ff;
      font-size: 13px;
      opacity: 0.9;
    }
    .piles strong { font-weight: 700; }
  </style>

  <!-- 🌐 Token/API boot; expose to scripts and persist token -->
  <script>
    (function () {
      const qs = new URLSearchParams(location.search);
      const tokenFromUrl = qs.get('token') || '';
      const apiFromUrl = (qs.get('api') || '').replace(/\/+$/, '');

      // Persist/reuse token across UIs
      let token = tokenFromUrl;
      try {
        if (!token) token = localStorage.getItem('sv13.token') || '';
        if (tokenFromUrl) localStorage.setItem('sv13.token', tokenFromUrl);
      } catch {}

      // Globals for any scripts (e.g., spectatorview.js)
      window.PLAYER_TOKEN = token;
      window.API_BASE = apiFromUrl || '/api';
      try { console.log('[Spectator] API_BASE =', window.API_BASE); } catch {}
    })();
  </script>
</head>
<body>
  <div id="background"></div>

  <!-- 🧱 Two-column layout: main content + right chat panel -->
  <div class="page">
    <!-- Main spectator column (all your existing content) -->
    <main id="spectator-main">
      <div class="spectator-header">
        <h1>Spectator View</h1>
        <p id="spectator-status">Waiting for match...</p>
        <p id="watching-count">Spectators Watching: 0</p>
      </div>

      <p id="turn-display" style="text-align:center; color:white; font-size:18px;"></p>

      <div class="duel-container">
        <!-- Opponent / Bot -->
        <div class="player" id="player2">
          <h2 id="player2-name">Opponent</h2>
          <div class="hp">HP: <span id="player2-hp">200</span></div>
          <div class="piles">
            Deck: <strong class="deck-count">0</strong> •
            Discard: <strong class="discard-count">0</strong>
          </div>
          <div class="field" id="player2-field"></div>
          <div class="hand" id="player2-hand"></div>
        </div>

        <!-- Challenger / Player1 -->
        <div class="player" id="player1">
          <h2 id="player1-name">Challenger</h2>
          <div class="hp">HP: <span id="player1-hp">200</span></div>
          <div class="piles">
            Deck: <strong class="deck-count">0</strong> •
            Discard: <strong class="discard-count">0</strong>
          </div>
          <div class="field" id="player1-field"></div>
          <div class="hand" id="player1-hand"></div>
        </div>
      </div>
    </main>

    <!-- ⭐ New: Spectator Chat right column -->
    <aside id="chat-panel" aria-label="Spectator chat">
      <header class="chat-header">
        <div class="chat-title">Live Chat</div>
        <div id="chat-presence" class="chat-presence">0 online</div>
      </header>

      <div id="chat-log" class="chat-log" role="log" aria-live="polite"></div>
      <div id="chat-typing" class="chat-typing" aria-live="polite"></div>

      <!-- prevent full page reload even if the module fails to attach -->
      <form id="chat-form" class="chat-form" autocomplete="off" onsubmit="event.preventDefault()">
        <input id="chat-input" type="text" placeholder="Message the crowd…" maxlength="500" />
        <button id="chat-send" type="submit" aria-label="Send message">Send</button>
      </form>
    </aside>
  </div>

  <!-- 🔔 Join toast mount (content injected via JS) -->
  <div id="joinToast" class="join-toast" role="status" aria-live="polite"></div>

  <!-- 🔊 Background music -->
  <audio
    id="spec-bgm"
    src="audio/bg/Follow the Trail.mp3"
    autoplay
    muted
    playsinline
    loop
    preload="auto"></audio>
  <button id="specAudioToggle" class="audio-toggle" aria-label="Mute background music">🔇</button>

  <script>
    // Autoplay-safe music control (unmutes on first tap/keypress)
    (function setupSpectatorMusic() {
      const audio = document.getElementById('spec-bgm');
      const btn   = document.getElementById('specAudioToggle');
      if (!audio || !btn) return;

      const STORE_KEY = 'sv13_spectator_bgm.muted';

      // Restore saved preference
      try {
        const stored = localStorage.getItem(STORE_KEY);
        if (stored !== null) audio.muted = (stored === 'true');
      } catch {}

      updateBtn();
      audio.play().catch(() => { /* will unlock on first gesture */ });

      // First user gesture: ensure playback; unmute unless user previously chose mute
      const unlock = () => {
        audio.play().catch(() => {});
        try {
          if (localStorage.getItem(STORE_KEY) !== 'true') {
            audio.muted = false;
            updateBtn();
          }
        } catch {}
        cleanupUnlock();
      };
      function cleanupUnlock() {
        window.removeEventListener('pointerdown', unlock, opt);
        window.removeEventListener('keydown', unlock);
        document.removeEventListener('visibilitychange', vis);
      }
      const opt = { passive: true };
      window.addEventListener('pointerdown', unlock, opt);
      window.addEventListener('keydown', unlock);

      // Safari quirk: retry when tab becomes visible
      const vis = () => { if (!document.hidden) audio.play().catch(() => {}); };
      document.addEventListener('visibilitychange', vis);

      // Manual toggle — now also flips volume to be extra-safe (+ touch handler for mobile)
      const toggle = () => {
        const willMute = !audio.muted;
        audio.muted = willMute;
        audio.volume = willMute ? 0 : 1;
        try { localStorage.setItem(STORE_KEY, String(audio.muted)); } catch {}
        updateBtn();
        audio.play().catch(() => {}); // keep playback active on unmute
      };
      btn.addEventListener('click', toggle);
      btn.addEventListener('touchend', (e) => { e.preventDefault(); toggle(); }, { passive: false });

      function updateBtn() {
        btn.textContent = audio.muted ? '🔇' : '🔊';
        btn.setAttribute('aria-label', audio.muted ? 'Play background music' : 'Mute background music');
      }
    })();

    // 🔵 Flash turn display blue whenever its text changes
    (function flashTurnOnUpdate() {
      const el = document.getElementById('turn-display');
      if (!el) return;
      const applyFlash = () => {
        el.classList.add('highlight-blue','flash-blue');
        setTimeout(() => el.classList.remove('flash-blue'), 1600);
      };
      // initial nudge in case first write happens immediately
      setTimeout(applyFlash, 200);
      const mo = new MutationObserver(applyFlash);
      mo.observe(el, { childList: true, characterData: true, subtree: true });
    })();

    // 🔔 Join toast: show "@name has joined the madness" for 10s (triggered by chatClient.js dispatch)
    (function joinToastListener() {
      const mount = document.getElementById('joinToast');
      if (!mount) return;

      let hideTimer = null;
      const show = (name) => {
        const safe = String(name || 'A player');
        mount.textContent = `@${safe} has joined the madness`;
        mount.classList.add('show','highlight-blue');
        clearTimeout(hideTimer);
        hideTimer = setTimeout(() => {
          mount.classList.remove('show','highlight-blue');
        }, 10000);
      };

      // Listen for a custom event dispatched by chatClient.js:
      // window.dispatchEvent(new CustomEvent('spectator:user_joined', { detail: { name } }))
      window.addEventListener('spectator:user_joined', (e) => show(e.detail?.name));
    })();
  </script>

  <!-- ↩ Return to Hub button (preserves token + api, override with ?hub=) -->
  <a id="hubBtn" class="hub-btn" href="#" role="button">↩ Return to Hub</a>
  <script>
    (function setHubLink(){
      const qs = new URLSearchParams(location.search);
      const token = window.PLAYER_TOKEN || qs.get('token') || '';
      const api   = (window.API_BASE || qs.get('api') || '').replace(/\/+$/, '');
      // allow override via ?hub=<url>
      const hub = qs.get('hub') || 'https://duel-ui-production.up.railway.app/';
      const url = new URL(hub);
      if (token) url.searchParams.set('token', token);
      if (api)   url.searchParams.set('api', api);
      const el = document.getElementById('hubBtn');
      if (el) el.href = url.toString();
    })();
  </script>

  <!-- Existing spectator logic -->
  <script src="scripts/spectatorview.js"></script>

  <!-- ✅ Ensure Socket.IO client is present as a global (works even if ESM import fails) -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>

  <!-- Realtime chat client (module) -->
  <script type="module" src="scripts/chatClient.js"></script>
</body>
</html>
